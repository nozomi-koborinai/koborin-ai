name: Terraform Release

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - ".github/workflows/release-infra.yml"
    tags:
      - "infra-v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to release infra to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
          - shared

jobs:
  terraform-release:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    timeout-minutes: 30

    environment: ${{ github.event.inputs.environment == 'shared' && 'shared (infra)' || ((startsWith(github.ref, 'refs/tags/infra-v') || github.event.inputs.environment == 'prod') && 'production (infra)' || 'development (infra)') }}

    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      REGION: asia-northeast1
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT_MAIL }}
      BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
      IAP_USER: ${{ secrets.IAP_USER }}
      OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
      OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Decide target environment
        id: decide-env
        run: |
          if [[ "$GITHUB_REF" == refs/tags/infra-v* ]]; then
            echo "TF_TARGET_ENV=prod" >> "$GITHUB_ENV"
          elif [ "${{ github.ref_name }}" = "main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "TF_TARGET_ENV=dev" >> "$GITHUB_ENV"
          else
            echo "TF_TARGET_ENV=${{ github.event.inputs.environment }}" >> "$GITHUB_ENV"
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.2"

      - name: Check Terraform Format
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: terraform fmt -check -diff -recursive

      - name: Initialize Terraform
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: |
          echo "Initializing Terraform for environment: $TF_TARGET_ENV"
          terraform init -input=false -backend-config="bucket=${{ env.BUCKET_NAME }}"

      - name: Validate Terraform
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: terraform validate

      - name: Get current Cloud Run image (if exists)
        if: env.TF_TARGET_ENV != 'shared'
        id: current-image
        run: |
          if [ "$TF_TARGET_ENV" = "prod" ]; then
            SERVICE_NAME="koborin-ai-web-prod"
          else
            SERVICE_NAME="koborin-ai-web-dev"
          fi
          CURRENT_IMAGE=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(spec.template.spec.containers[0].image)' 2>/dev/null || echo "gcr.io/cloudrun/hello")
          echo "CURRENT_IMAGE=${CURRENT_IMAGE}" >> $GITHUB_OUTPUT
          echo "Current image: ${CURRENT_IMAGE}"

      - name: Run Terraform Plan (Pre-Apply Check)
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: |
          PLAN_ARGS="-no-color -lock=false -input=false"
          PLAN_ARGS="$PLAN_ARGS -var=project_id=${{ env.PROJECT_ID }}"
          PLAN_ARGS="$PLAN_ARGS -var=project_number=${{ env.PROJECT_NUMBER }}"
          
          if [ "$TF_TARGET_ENV" = "shared" ]; then
            # Shared stack needs OAuth credentials and IAP user for dev backend IAP configuration
            PLAN_ARGS="$PLAN_ARGS -var=iap_user=${{ env.IAP_USER }}"
            PLAN_ARGS="$PLAN_ARGS -var=oauth_client_id=${{ env.OAUTH_CLIENT_ID }}"
            PLAN_ARGS="$PLAN_ARGS -var=oauth_client_secret=${{ env.OAUTH_CLIENT_SECRET }}"
          else
            # Dev/Prod stacks need image URI
            PLAN_ARGS="$PLAN_ARGS -var=image_uri=${{ steps.current-image.outputs.CURRENT_IMAGE }}"
          fi
          
          terraform plan $PLAN_ARGS

      - name: Run Terraform Apply
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: |
          APPLY_ARGS="-auto-approve -input=false"
          APPLY_ARGS="$APPLY_ARGS -var=project_id=${{ env.PROJECT_ID }}"
          APPLY_ARGS="$APPLY_ARGS -var=project_number=${{ env.PROJECT_NUMBER }}"
          
          if [ "$TF_TARGET_ENV" = "shared" ]; then
            # Shared stack needs OAuth credentials and IAP user for dev backend IAP configuration
            APPLY_ARGS="$APPLY_ARGS -var=iap_user=${{ env.IAP_USER }}"
            APPLY_ARGS="$APPLY_ARGS -var=oauth_client_id=${{ env.OAUTH_CLIENT_ID }}"
            APPLY_ARGS="$APPLY_ARGS -var=oauth_client_secret=${{ env.OAUTH_CLIENT_SECRET }}"
          else
            # Dev/Prod stacks need image URI
            APPLY_ARGS="$APPLY_ARGS -var=image_uri=${{ steps.current-image.outputs.CURRENT_IMAGE }}"
          fi
          
          terraform apply $APPLY_ARGS

      - name: Get current Cloud Run image for verification
        if: always() && env.TF_TARGET_ENV != 'shared'
        id: current-image-verify
        run: |
          if [ "$TF_TARGET_ENV" = "prod" ]; then
            SERVICE_NAME="koborin-ai-web-prod"
          else
            SERVICE_NAME="koborin-ai-web-dev"
          fi
          CURRENT_IMAGE=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(spec.template.spec.containers[0].image)' 2>/dev/null || echo "gcr.io/cloudrun/hello")
          echo "CURRENT_IMAGE=${CURRENT_IMAGE}" >> $GITHUB_OUTPUT
          echo "Using image for plan verification: ${CURRENT_IMAGE}"

      - name: Run Terraform Plan (Verify No Drift)
        if: always()
        working-directory: infra/${{ env.TF_TARGET_ENV }}
        run: |
          PLAN_ARGS="-no-color -lock=false -input=false -detailed-exitcode"
          PLAN_ARGS="$PLAN_ARGS -var=project_id=${{ env.PROJECT_ID }}"
          PLAN_ARGS="$PLAN_ARGS -var=project_number=${{ env.PROJECT_NUMBER }}"
          
          if [ "$TF_TARGET_ENV" = "shared" ]; then
            # Shared stack needs OAuth credentials and IAP user for dev backend IAP configuration
            PLAN_ARGS="$PLAN_ARGS -var=iap_user=${{ env.IAP_USER }}"
            PLAN_ARGS="$PLAN_ARGS -var=oauth_client_id=${{ env.OAUTH_CLIENT_ID }}"
            PLAN_ARGS="$PLAN_ARGS -var=oauth_client_secret=${{ env.OAUTH_CLIENT_SECRET }}"
          else
            # Dev/Prod stacks need image URI
            PLAN_ARGS="$PLAN_ARGS -var=image_uri=${{ steps.current-image-verify.outputs.CURRENT_IMAGE }}"
          fi
          
          # Exit code 0 = no changes, 1 = error, 2 = changes present
          terraform plan $PLAN_ARGS || exit_code=$?
          if [ "${exit_code:-0}" -eq 2 ]; then
            echo "::warning::Drift detected after apply. Review the plan output above."
          fi
