name: App Release

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "content/**"
      - ".github/workflows/app-release.yml"
      - ".github/workflows/app-ci.yml"
    tags:
      - "app-v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy app to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  build:
    name: Build and Push Container Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    timeout-minutes: 20

    environment: ${{ (startsWith(github.ref, 'refs/tags/app-v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')) && 'production (app)' || 'development (app)' }}

    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      REGION: asia-northeast1
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT_MAIL }}

    outputs:
      image_uri: ${{ steps.build-image.outputs.IMAGE_URI }}
      target_env: ${{ steps.decide-env.outputs.TARGET_ENV }}
      service_name: ${{ steps.decide-env.outputs.SERVICE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide deployment environment
        id: decide-env
        run: |
          TARGET_ENV="dev"
          SERVICE_NAME="koborin-ai-web-dev"
          if [[ "${GITHUB_REF}" == refs/tags/app-v* ]]; then
            TARGET_ENV="prod"
            SERVICE_NAME="koborin-ai-web-prod"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && "${{ github.event.inputs.environment }}" == "prod" ]]; then
            TARGET_ENV="prod"
            SERVICE_NAME="koborin-ai-web-prod"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            if [[ "${TARGET_ENV}" == "prod" ]]; then
              SERVICE_NAME="koborin-ai-web-prod"
            fi
          fi
          echo "TARGET_ENV=${TARGET_ENV}" >> "$GITHUB_OUTPUT"
          echo "SERVICE_NAME=${SERVICE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: latest

      - name: Configure gcloud defaults
        run: |
          gcloud config set project "${{ env.PROJECT_ID }}"
          gcloud config set run/region "${{ env.REGION }}"

      - name: Build and push Docker image
        id: build-image
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          IMAGE_URI="asia-northeast1-docker.pkg.dev/${{ env.PROJECT_ID }}/koborin-ai-web/app:${IMAGE_TAG}"
          gcloud builds submit "./app" \
            --tag="${IMAGE_URI}" \
            --project="${{ env.PROJECT_ID }}" \
            --region="${{ env.REGION }}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy via CDKTF
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    timeout-minutes: 30

    environment: ${{ (startsWith(github.ref, 'refs/tags/app-v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')) && 'production (app)' || 'development (app)' }}

    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      REGION: asia-northeast1
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT_MAIL }}
      BUCKET_NAME: ${{ secrets.BUCKET_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: latest

      - name: Configure gcloud defaults
        run: |
          gcloud config set project "${{ env.PROJECT_ID }}"
          gcloud config set run/region "${{ env.REGION }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: infrastructure/package-lock.json

      - name: Install CDKTF dependencies
        working-directory: infrastructure
        run: npm ci

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Generate CDKTF providers
        working-directory: infrastructure
        run: npx cdktf get

      - name: Build CDKTF project
        working-directory: infrastructure
        run: |
          rm -rf lib cdktf.out
          npm run build

      - name: Synthesize Terraform configuration
        working-directory: infrastructure
        env:
          TF_TARGET_ENV: ${{ needs.build.outputs.target_env }}
        run: |
          echo "Synthesizing for environment: $TF_TARGET_ENV"
          npx cdktf synth

      - name: Check Terraform format
        working-directory: infrastructure/cdktf.out/stacks/${{ needs.build.outputs.target_env }}
        run: terraform fmt -check -diff -recursive

      - name: Initialize Terraform
        working-directory: infrastructure/cdktf.out/stacks/${{ needs.build.outputs.target_env }}
        env:
          BACKEND_PREFIX: ${{ needs.build.outputs.target_env }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ env.BUCKET_NAME }}" \
            -backend-config="prefix=$BACKEND_PREFIX"

      - name: Terraform Plan
        working-directory: infrastructure/cdktf.out/stacks/${{ needs.build.outputs.target_env }}
        run: |
          terraform plan -no-color -lock=false -input=false \
            -var=project_id=${{ env.PROJECT_ID }} \
            -var=project_number=${{ env.PROJECT_NUMBER }} \
            -var=bucket_name=${{ env.BUCKET_NAME }} \
            -var=image_uri=${{ needs.build.outputs.image_uri }}

      - name: Terraform Apply
        working-directory: infrastructure/cdktf.out/stacks/${{ needs.build.outputs.target_env }}
        run: |
          terraform apply -auto-approve -input=false \
            -var=project_id=${{ env.PROJECT_ID }} \
            -var=project_number=${{ env.PROJECT_NUMBER }} \
            -var=bucket_name=${{ env.BUCKET_NAME }} \
            -var=image_uri=${{ needs.build.outputs.image_uri }}

      - name: Retrieve deployed service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ needs.build.outputs.service_name }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(status.url)')
          echo "SERVICE_URL=${URL}" >> "$GITHUB_OUTPUT"
          echo "Deployed to: ${URL}"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.build.outputs.target_env }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ needs.build.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.build.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: ${{ steps.service-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY

