---
title: koborin.ai ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
description: Astro Ã— Pulumi Go Ã— Google Cloud ã§ä½œã‚‹å€‹äººã‚µã‚¤ãƒˆ
ogImage: /og/koborin-ai-architecture.png
publishedAt: 2026-01-02
---

import { Image } from 'astro:assets';
import RichLinkCard from '../../../../components/RichLinkCard.astro';
import gcsImage from '../../../../assets/tech/koborin-ai-architecture/gcs.png';
import dnsImage from '../../../../assets/tech/koborin-ai-architecture/dns.png';
import iap1Image from '../../../../assets/tech/koborin-ai-architecture/iap-1.png';
import iap2Image from '../../../../assets/tech/koborin-ai-architecture/iap-2.png';

<img src="/og/koborin-ai-architecture.png" alt="og" width="750" height="396" fetchpriority="high" style="width: 100%; height: auto;" />

ã“ã®ã‚µã‚¤ãƒˆ [koborin.ai](https://koborin.ai) ã¯ã€è‡ªèº«ã®æŠ€è¡“ãƒ¡ãƒ¢ã‚„æ€è€ƒã‚’ç™ºä¿¡ã™ã‚‹ãŸã‚ã®å€‹äººã‚µã‚¤ãƒˆ (Technical Garden) ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã‚µã‚¤ãƒˆå…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è¨­è¨ˆæ€æƒ³ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã‚¤ãƒ³ãƒ•ãƒ©ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸¡é¢ã‹ã‚‰ã€ãªãœã“ã®æ§‹æˆã‚’é¸ã‚“ã ã®ã‹ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

---

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã¾ãšã€ã‚µã‚¤ãƒˆå…¨ä½“ã®æ§‹æˆã‚’ä¿¯ç°ã—ã¾ã™ã€‚

```mermaid
---
title: "Google Cloud Project"
---
flowchart LR
    subgraph PULUMI_STATE["Pulumi State"]
        STATE_SHARED["shared"]
        STATE_DEV["dev"]
        STATE_PROD["prod"]
    end
    
    subgraph SHARED["Shared"]
        APIS["APIs"]
        ARTIFACT["Artifact Registry"]
        WIF["WIF"]
    end
    
    subgraph DNS["Cloudflare DNS"]
        DEV_DOMAIN["dev.koborin.ai"]
        PROD_DOMAIN["koborin.ai"]
    end
    
    subgraph LB["HTTPS LB"]
        STATIC_IP["Static IP"]
        SSL_CERT["SSL Cert"]
        URL_MAP["URL Map"]
        HTTPS_PROXY["HTTPS Proxy"]
    end
    
    subgraph DEV_BACKEND["Dev Backend"]
        DEV_IAP["IAP"]
        DEV_NEG["NEG"]
        DEV_CR["Cloud Run Dev"]
    end
    
    subgraph PROD_BACKEND["Prod Backend"]
        PROD_NEG["NEG"]
        PROD_CR["Cloud Run Prod"]
    end
    
    subgraph CICD["GitHub Actions"]
        GH_WIF["WIF Auth"]
        PULUMI_SA["Pulumi SA"]
    end
    
    STATE_SHARED -.-> SHARED
    STATE_SHARED -.-> LB
    STATE_DEV -.-> DEV_BACKEND
    STATE_PROD -.-> PROD_BACKEND
    
    ARTIFACT -.-> DEV_CR
    ARTIFACT -.-> PROD_CR
    
    DEV_DOMAIN --> STATIC_IP
    PROD_DOMAIN --> STATIC_IP
    STATIC_IP --> SSL_CERT
    SSL_CERT --> HTTPS_PROXY
    HTTPS_PROXY --> URL_MAP
    
    URL_MAP --> DEV_IAP
    URL_MAP --> PROD_NEG
    
    DEV_IAP --> DEV_NEG
    DEV_NEG --> DEV_CR
    PROD_NEG --> PROD_CR
    
    GH_WIF -.-> WIF
    WIF -.-> PULUMI_SA
    PULUMI_SA -.-> PULUMI_STATE
```

### å›³ä¸­ã®ç”¨èª

| ç•¥èª | æ­£å¼åç§° | èª¬æ˜ |
| --- | --- | --- |
| LB | Load Balancer | è² è·åˆ†æ•£è£…ç½®ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é©åˆ‡ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ |
| NEG | Network Endpoint Group | Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¥ç¶šãƒã‚¤ãƒ³ãƒˆ |
| WIF | Workload Identity Federation | GitHub Actions ã‹ã‚‰ Google Cloud ã¸ã®èªè¨¼ |
| IAP | Identity-Aware Proxy | Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ |

### ãƒã‚¤ãƒ³ãƒˆ

- **DNSï¼ˆCloudflareï¼‰â†’ Global HTTPS LB â†’ Cloud Runï¼ˆdev/prodï¼‰** ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹
- **dev ç’°å¢ƒã¯ IAP ã§ä¿è­·** + `X-Robots-Tag: noindex` ã§æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œãªã„
- **GitHub Actions â†’ Workload Identity Federation â†’ Cloud Build / Pulumi** ã§ CI/CD ã‚’å®Ÿç¾

---

## è¨­è¨ˆæ€æƒ³

ã“ã®ã‚µã‚¤ãƒˆã‚’ä½œã‚‹ã«ã‚ãŸã£ã¦è€ƒãˆãŸã“ã¨ã‚’ã€ã‚¤ãƒ³ãƒ•ãƒ©ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸¡é¢ã‹ã‚‰èª¬æ˜ã—ã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ

#### 1 ã¤ã® Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ + 3 ã‚¹ã‚¿ãƒƒã‚¯

ä¾‹ãˆã°ã€åŒ»ç™‚ç³»ã‚„é‡‘èç³»ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå³æ ¼ãªè¦ä»¶ãŒã‚ã‚Šã€**Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’åˆ†ã‘ã‚‹**ã®ãŒä¸€èˆ¬çš„ã§ã™ï¼š

- ç›£æŸ»è¨¼è·¡ã‚„ãƒ­ã‚°ã®å®Œå…¨åˆ†é›¢
- ã€Œèª°ãŒç®¡ç†ç”»é¢ã‚’è§¦ã‚Œã‚‹ã‹ã€ã®æ¨©é™åˆ†é›¢
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ã¸ã®å¯¾å¿œ

ä»Šå›ã¯å€‹äººã‚µã‚¤ãƒˆãªã®ã§ã€ãã“ã¾ã§ã®å³æ ¼ã•ã¯ä¸è¦ã§ã™ã€‚

ãŸã ã—ã€**é–‹ç™ºè€…ä½“é¨“ã¨ã—ã¦ dev/prod ã®åŒºåˆ†ã‘ã¯æ¬²ã—ã„**ã€‚
æœ¬ç•ªç’°å¢ƒã§ç›´æ¥è©¦ã™ã®ã¯ãƒªã‚¹ã‚¯ãŒå¤§ãã„ã§ã™ã—ã€å¤‰æ›´ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ãŒã‚ã‚Šã¾ã™ã€‚

ãã“ã§ã€**ã‚³ã‚¹ãƒˆã¨é‹ç”¨è² æ‹…ã‚’æŠ‘ãˆã‚‹ãŸã‚ Google Cloud project ã¯ 1 ã¤** ã«ã—ã¦ã€ãã®ä¸­ã§ãƒªã‚½ãƒ¼ã‚¹ï¼ˆä¸»ã« Cloud Runï¼‰ã‚’ dev ç”¨ / prod ç”¨ã§åˆ†ã‘ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

#### IaC ã«ãŠã‘ã‚‹ State

Pulumi ã‚„ Terraform ãªã©ã® IaC ãƒ„ãƒ¼ãƒ«ã§ã¯ã€ã€Œç¾åœ¨ã©ã®ãƒªã‚½ãƒ¼ã‚¹ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ã€ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã« **Stateï¼ˆçŠ¶æ…‹ï¼‰** ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã¾ã™ã€‚

State ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå½¹å‰²ã‚’æŒã¡ã¾ã™ï¼š

- ãƒªã‚½ãƒ¼ã‚¹ã®ç¾åœ¨çŠ¶æ…‹ã‚’è¨˜éŒ²ï¼šã€Œã“ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ä½œæˆæ¸ˆã¿ã€ã€Œã“ã®ãƒªã‚½ãƒ¼ã‚¹ã¯å‰Šé™¤ã•ã‚ŒãŸã€ãªã©ã‚’è¿½è·¡
- å·®åˆ†æ¤œå‡ºã®åŸºæº–ï¼šã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¨ State ã‚’æ¯”è¼ƒã—ã¦ã€ä½•ã‚’ä½œæˆ/æ›´æ–°/å‰Šé™¤ã™ã¹ãã‹ã‚’åˆ¤æ–­
- ãƒãƒ¼ãƒ é–‹ç™ºã§ã®åŒæœŸï¼šState ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°äººãŒåŒã˜ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ“ä½œã§ãã‚‹

ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€Pulumi ã® State ã‚’ GCSï¼ˆGoogle Cloud Storageï¼‰ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
ã‚¹ã‚¿ãƒƒã‚¯ã”ã¨ã«åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

<Image src={gcsImage} alt="gcs" width={750} quality={80} />

`shared.json`ã€`dev.json`ã€`prod.json` ãŒãã‚Œãã‚Œã®ã‚¹ã‚¿ãƒƒã‚¯ã® State ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

#### shared / dev / prod ã®è²¬å‹™

| Stack | è²¬å‹™ |
| --- | --- |
| `shared` | å…±é€šãƒªã‚½ãƒ¼ã‚¹ (LB, WIF, Artifact Registry, Managed SSL Cert) |
| `dev` | é–‹ç™ºç”¨ Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ `koborin-ai-web-dev` |
| `prod` | æœ¬ç•ªç”¨ Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ `koborin-ai-web-prod` |

ã“ã“ã§ `shared` ã¯ã€Œç’°å¢ƒã€ã¨ã„ã†ã‚ˆã‚Šã‚‚ã€**å…±é€šãƒªã‚½ãƒ¼ã‚¹ã‚’ã¾ã¨ã‚ã‚‹ State ã®å¢ƒç•Œ**ã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚

LB ã¯ 1 ã¤ã§ã€ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹ã®ã§ã€dev / prod ã©ã¡ã‚‰ã‹ã‚‰è¦‹ã¦ã‚‚å…±é€šã®ãƒªã‚½ãƒ¼ã‚¹ã«ãªã‚Šã¾ã™ã€‚
Artifact Registry ã‚„ Workload Identity Federation ã‚‚åŒæ§˜ã«ç’°å¢ƒã‚’è·¨ã„ã§ä½¿ã†ãŸã‚ã€shared ã«é…ç½®ã™ã‚‹ã®ãŒè‡ªç„¶ã§ã™ã€‚

#### IaC ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å¤‰æ›´: CDKTF â†’ Pulumi Go

ã“ã®ã‚µã‚¤ãƒˆã® IaC ã¯ã€å½“åˆ **CDK for Terraformï¼ˆCDKTFï¼‰** ã§æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚

<RichLinkCard href="https://github.com/hashicorp/terraform-cdk" title="hashicorp/terraform-cdk: Define infrastructure resources using programming languages" description="CDK for Terraform (CDKTF) allows you to define infrastructure using familiar programming languages." />

ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ç®¡ç†ã—ã¤ã¤ã€TypeScript ã§ **å‹å®‰å…¨** ã« Terraform ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã§ãã‚‹ç‚¹ãŒæ°—ã«å…¥ã£ã¦ã„ã¾ã—ãŸã€‚

ã—ã‹ã—ã€2025/12/10 ã« CDKTF ã¯ **sunset / archivedï¼ˆé–‹ç™ºçµ‚äº†ï¼‰** ã«ãªã‚Šã¾ã—ãŸã€‚

> Terraform CDK (CDKTF) will sunset and be archived on December 10, 2025. HashiCorp, an IBM Company, will no longer maintain or develop the project after that date.

ç§»è¡Œå…ˆã¨ã—ã¦ **Pulumi Go** ã‚’é¸ã³ã¾ã—ãŸã€‚ç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. **Go ãŒå¥½ã**ï¼šGo ã‚’æ›¸ãæ©Ÿä¼šãŒå¢—ãˆã¦ãã¦ãŠã‚Šã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰ã‚‚ Go ã§çµ±ä¸€ã§ãã‚‹ã®ã¯å¬‰ã—ã„
2. **åŒã˜ "ã‚³ãƒ¼ãƒ‰ã§æ›¸ã IaC" ã®æ–‡è„ˆ**ï¼šCDKTF ã¨åŒæ§˜ã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’å®šç¾©ã§ãã‚‹
3. **æ—¢å­˜ã®è¨­è¨ˆã‚’å´©ã—ã«ãã„**ï¼šãƒªã‚½ãƒ¼ã‚¹ã®æ§‹é€ ã‚„è€ƒãˆæ–¹ã¯ä¼¼ã¦ã„ã‚‹ã®ã§ã€ç§»è¡Œã‚³ã‚¹ãƒˆãŒæ¯”è¼ƒçš„ä½ã„

<RichLinkCard href="https://www.pulumi.com/docs/iac/languages-sdks/go/" title="Go | Pulumi Docs" description="Pulumi supports writing your infrastructure as code using Go." />

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

#### è‡ªå‰ã® API / DB ã¯ä¸è¦

å€‹äººã‚µã‚¤ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¦ä»¶ã‚’è€ƒãˆã¾ã—ãŸï¼š

- æŠ€è¡“ãƒ¡ãƒ¢ã‚„æ€è€ƒã‚’ Markdownï¼ˆMDXï¼‰ã§æ›¸ã„ã¦å…¬é–‹ã—ãŸã„
- å‹•çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¯ä¸è¦
- ã§ãã‚‹ã ã‘ã‚·ãƒ³ãƒ—ãƒ«ã«é‹ç”¨ã—ãŸã„

ã“ã®è¦ä»¶ã§ã‚ã‚Œã°ã€**è‡ªå‰ã® API ã‚µãƒ¼ãƒãƒ¼ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ä¸è¦**ã§ã™ã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é™çš„ã«ç”Ÿæˆã™ã‚Œã°ååˆ†ã§ã™ã€‚

#### GitHub ã‚’ CMS ã¨ã—ã¦æ´»ç”¨

ç§è‡ªèº«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãªã®ã§ã€CMSï¼ˆWordPress ã‚„ Notion ãªã©ï¼‰ã‚’ä½¿ã‚ãªãã¦ã‚‚ã€**GitHub ãƒªãƒã‚¸ãƒˆãƒªã§ç›´æ¥ MDX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†**ã™ã‚Œã°ååˆ†ã§ã™ã€‚

- è¨˜äº‹ã®ä½œæˆãƒ»ç·¨é›†ã¯ Git ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- PR ãƒ™ãƒ¼ã‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¯èƒ½
- CI/CD ã§è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã‚Œã«ã‚ˆã‚Šã€åˆ¥é€”ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€é‹ç”¨ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚

#### Starlight ã®æ¡ç”¨

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®é¸å®šã«ã‚ãŸã£ã¦ã€[genkit.dev](https://genkit.dev) ã®ã‚µã‚¤ãƒˆæ§‹æˆã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚genkit.dev ã¯ Starlight ã‚’ä½¿ã£ã¦ãŠã‚Šã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µã‚¤ãƒˆã¨ã—ã¦æ´—ç·´ã•ã‚ŒãŸ UX ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

<RichLinkCard href="https://starlight.astro.build/" title="Starlight" description="Build beautiful, accessible, high-performance documentation websites with Astro." />

Starlight ã‚’é¸ã‚“ã ç†ç”±ï¼š

- **Astro ãƒ™ãƒ¼ã‚¹**ï¼šé™çš„ã‚µã‚¤ãƒˆç”Ÿæˆã«ç‰¹åŒ–ã—ã¦ãŠã‚Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„
- **å¤šè¨€èªå¯¾å¿œ**ï¼šè‹±èªã¨æ—¥æœ¬èªã®ä¸¡æ–¹ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æä¾›ã§ãã‚‹
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‘ã‘æ©Ÿèƒ½**ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ã€æ¤œç´¢ã€ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãªã©ãŒæ¨™æº–è£…å‚™
- **MDX ã‚µãƒãƒ¼ãƒˆ**ï¼šReact ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ Markdown å†…ã§ä½¿ãˆã‚‹

---

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹

ã“ã“ã‹ã‚‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã®æµã‚Œã‚’èª¬æ˜ã—ã¾ã™ã€‚

### 1. DNS è§£æ±º (Cloudflare)

ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã‚‚ã¨ã‚‚ã¨ Cloudflare ã§å–å¾—ã—ã¦ã„ãŸã®ã§ã€Cloudflare ã® A ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ `koborin.ai` ã¨ `dev.koborin.ai` ãŒ Google Cloud å´ã®é™çš„ IP ã‚’å‘ãã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
â€» DNS ã¯ Cloudflare ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¨­å®šã—ã¦ã„ã¾ã™ã€‚

<Image src={dnsImage} alt="dns" width={750} quality={80} />

### 2. Global HTTPS Load Balancer

é™çš„ IP ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒæ¥ã‚‹ã¨ã€**Global HTTPS Load Balancer** ãŒå—ã‘å–ã‚Šã¾ã™ã€‚

LB ã¯ **URL Map** ã‚’ä½¿ã£ã¦ã€ãƒ›ã‚¹ãƒˆåã«å¿œã˜ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æŒ¯ã‚Šåˆ†ã‘ã¾ã™ï¼š

<RichLinkCard href="https://cloud.google.com/load-balancing/docs/url-map" title="URL maps overview | Load Balancing | Google Cloud" description="URL maps define matching patterns for URL-based routing of requests to the appropriate backend services." />

- `koborin.ai` â†’ Prod Backend Service â†’ Cloud Run `koborin-ai-web-prod`
- `dev.koborin.ai` â†’ Dev Backend Service â†’ Cloud Run `koborin-ai-web-dev`

### 3. IAP ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

`dev.koborin.ai` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€**Identity-Aware Proxyï¼ˆIAPï¼‰** ãŒå‰æ®µã§èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

<RichLinkCard href="https://cloud.google.com/iap/docs/concepts-overview" title="IAP overview | Identity-Aware Proxy | Google Cloud" description="Identity-Aware Proxy (IAP) lets you establish a central authorization layer for applications accessed by HTTPS." />

ç§ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã ã‘ãŒã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã•ã‚Œã¦ãŠã‚Šã€ãã‚Œä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚

<table>
  <thead>
    <tr><th>çŠ¶æ…‹</th><th>ã‚¤ãƒ¡ãƒ¼ã‚¸</th></tr>
  </thead>
  <tbody>
    <tr><td>ã‚¢ã‚¯ã‚»ã‚¹æ™‚</td><td><Image src={iap1Image} alt="iap-1" width={400} quality={80} /></td></tr>
    <tr><td>ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦æ™‚</td><td><Image src={iap2Image} alt="iap-2" width={400} quality={80} /></td></tr>
  </tbody>
</table>

ã•ã‚‰ã«ã€dev ç’°å¢ƒã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ `X-Robots-Tag: noindex, nofollow` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ã¦ã„ã‚‹ãŸã‚ã€ä¸‡ãŒä¸€ã‚¢ã‚¯ã‚»ã‚¹ã§ããŸã¨ã—ã¦ã‚‚æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œã¾ã›ã‚“ã€‚

---

## ã‚µã‚¤ãƒˆæ©Ÿèƒ½

ã“ã“ã§ã¯ã€ã“ã®ã‚µã‚¤ãƒˆãŒæä¾›ã—ã¦ã„ã‚‹æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### llms.txt

ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€`/llms.txt` ã§ LLM å‘ã‘ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
| --- | --- |
| `/llms.txt` | å…¨ãƒãƒªã‚¢ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯ä¸€è¦§ |
| `/llms-full.txt` | è‹±èªè¨˜äº‹ã™ã¹ã¦ (Markdown æœ¬æ–‡è¾¼ã¿) |
| `/llms-ja-full.txt` | æ—¥æœ¬èªè¨˜äº‹ã™ã¹ã¦ (Markdown æœ¬æ–‡è¾¼ã¿) |
| `/llms-tech.txt`, `/llms-ja-tech.txt` | Tech ã‚«ãƒ†ã‚´ãƒªã®ã¿ |
| `/llms-life.txt`, `/llms-ja-life.txt` | Life ã‚«ãƒ†ã‚´ãƒªã®ã¿ |

```text
# koborin.ai
> Personal site + technical garden.

## Full (with article content)
- https://koborin.ai/llms-full.txt
- https://koborin.ai/llms-ja-full.txt

## By Category

### Tech
- https://koborin.ai/llms-tech.txt
- https://koborin.ai/llms-ja-tech.txt

### Life
- https://koborin.ai/llms-life.txt
- https://koborin.ai/llms-ja-life.txt
```

OSS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `llms.txt` ã¯ã€ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã‚„ä½¿ã„æ–¹ã‚’ LLM ã«ç†è§£ã—ã¦ã‚‚ã‚‰ã†ã€ã¨ã„ã†ç›®çš„ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
ã“ã‚Œã¯ã¨ã¦ã‚‚æœ‰ç”¨ã§ã€LLM ãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

å€‹äººã‚µã‚¤ãƒˆã®å ´åˆã¯ã€ã¾ãŸåˆ¥ã®ä½¿ã„æ–¹ãŒã§ãã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
è‡ªåˆ†ã®æ€è€ƒã‚„æŠ€è¡“ãƒ¡ãƒ¢ãŒè“„ç©ã•ã‚Œã¦ã„ãï¼ˆå°‘ãªãã¨ã‚‚ç¾æ™‚ç‚¹ã§ã¯ãã®æƒ³å®šã€‚ã€‚ç¶šã‘ãŸã„ã€‚ã€‚ç¬‘ï¼‰ã®ã§ã€å°†æ¥ã€Œéå»ã«è‡ªåˆ†ãŒä½•ã‚’è€ƒãˆã¦ã„ãŸã‹ã€ã‚’ LLM ã«å‚ç…§ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ãªå ´é¢ã§å½¹ç«‹ã¤ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ãã†ã„ã£ãŸå¯èƒ½æ€§ã‚’è¦‹æ®ãˆã¦ã€è¨˜äº‹æœ¬æ–‡ã‚’å«ã‚€å½¢å¼ã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

### Engagement Features

è¨˜äº‹ãƒšãƒ¼ã‚¸ã«ã¯ã€èª­è€…ã¨ã®ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’ä¿ƒé€²ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

#### Giscusï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰

[Giscus](https://giscus.app) ã¯ã€GitHub Discussions ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

- èª­è€…ã¯ GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¯èƒ½
- ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Discussions ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€åˆ¥é€”ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦
- ã‚µã‚¤ãƒˆã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«è‡ªå‹•è¿½å¾“

#### Webmentionï¼ˆå¤–éƒ¨ã‹ã‚‰ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼‰

[Webmention](https://webmention.io) ã¯ã€W3C æ¨™æº–ã® IndieWeb ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚

- ä»–ã®ã‚µã‚¤ãƒˆã‚„ãƒ–ãƒ­ã‚°ã‹ã‚‰ã“ã®è¨˜äº‹ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ¤œçŸ¥
- Mastodon ãªã©ã® SNS ã‹ã‚‰ã®ã€Œã„ã„ã­ã€ã‚„ã€Œãƒªãƒã‚¹ãƒˆã€ã‚’é›†ç´„
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹çµŒç”±ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ•°ã‚’è¡¨ç¤º

#### Share Buttonsï¼ˆã‚·ã‚§ã‚¢ï¼‰

è¨˜äº‹ã‚’ SNS ã§ã‚·ã‚§ã‚¢ã™ã‚‹ãŸã‚ã®ãƒœã‚¿ãƒ³ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ï¼š

- Xï¼ˆæ—§ Twitterï¼‰
- Bluesky
- Mastodon
- ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
- ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã¯ã€**frontmatter ã« `publishedAt` ãŒã‚ã‚‹è¨˜äº‹ãƒšãƒ¼ã‚¸ã®ã¿**ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¸ã‚„ä¸€èˆ¬çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

---

## CI/CD

CI/CD ã¯ GitHub Actions ã§å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TB
    subgraph PR["Pull Request"]
        appCI["app-ci.yml"]
        planInfra["plan-infra.yml"]
    end
    
    subgraph Merge["main merge"]
        appRelease["app-release.yml"]
        releaseInfra["release-infra.yml"]
    end
    
    subgraph Build["Build"]
        cloudBuild["Cloud Build"]
        artifactRegistry["Artifact Registry"]
    end
    
    subgraph Deploy["Pulumi Deploy"]
        configImageUri["config set imageUri"]
        pulumiUp["pulumi up"]
    end
    
    subgraph CloudRun["Cloud Run"]
        devService["dev"]
        prodService["prod"]
    end
    
    appRelease --> cloudBuild
    cloudBuild --> artifactRegistry
    artifactRegistry --> configImageUri
    configImageUri --> pulumiUp
    pulumiUp --> devService
    pulumiUp --> prodService
    
    releaseInfra --> pulumiUp
```

### App ã®ãƒ‡ãƒ—ãƒ­ã‚¤

| ãƒˆãƒªã‚¬ãƒ¼ | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | å‡¦ç†å†…å®¹ |
| --- | --- | --- |
| PR æ™‚ | `app-ci.yml` | lint / typecheck / build ã®æ¤œè¨¼ |
| main ãƒãƒ¼ã‚¸æ™‚ | `app-release.yml` | Cloud Build â†’ Artifact Registry â†’ `pulumi up` |
| `app-v*` ã‚¿ã‚° | `app-release.yml` | ä¸Šè¨˜ã¨åŒã˜ï¼ˆprod ç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ |

### Infra ã®ãƒ‡ãƒ—ãƒ­ã‚¤

| ãƒˆãƒªã‚¬ãƒ¼ | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | å‡¦ç†å†…å®¹ |
| --- | --- | --- |
| PR æ™‚ | `plan-infra.yml` | `pulumi preview` ã§å¤‰æ›´å†…å®¹ã‚’ç¢ºèª |
| main ãƒãƒ¼ã‚¸æ™‚ | `release-infra.yml` | `pulumi up` ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’é©ç”¨ |
| `infra-v*` ã‚¿ã‚° | `release-infra.yml` | ä¸Šè¨˜ã¨åŒã˜ï¼ˆprod ç’°å¢ƒã¸é©ç”¨ï¼‰ |

App ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚ Infra ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚ã€æœ€çµ‚çš„ã«ã¯ **Pulumi ã‚’é€šã˜ã¦ Cloud Run ã®è¨­å®šã‚’æ›´æ–°**ã—ã¦ã„ã¾ã™ã€‚

`gcloud run deploy` ã‚³ãƒãƒ³ãƒ‰ã‚’ç›´æ¥ä½¿ã†ã®ã§ã¯ãªãã€ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼š

1. Cloud Build ã§ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Artifact Registry ã«ãƒ—ãƒƒã‚·ãƒ¥
2. `pulumi config set imageUri <æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸URI>` ã§ Pulumi ã®è¨­å®šã‚’æ›´æ–°
3. `pulumi up` ã§ Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å·®ã—æ›¿ãˆ

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ã‚¤ãƒ³ãƒ•ãƒ©ã®çŠ¶æ…‹ãŒå¸¸ã« Pulumi ã® State ã¨ä¸€è‡´ã—ã¾ã™ã€‚
æ‰‹å‹•ã§ `gcloud run deploy` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ State ã¨ã®ä¹–é›¢ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€Pulumi çµŒç”±ã§ã‚ã‚Œã°ãã®å¿ƒé…ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

### å¤‰æ›´ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹ CI ã®æœ€é©åŒ–

ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€PR ã®å¤‰æ›´å†…å®¹ã«å¿œã˜ã¦ CI ã®å®Ÿè¡Œç¯„å›²ã‚’èª¿æ•´ã™ã‚‹ä»•çµ„ã¿ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚

ã“ã®è€ƒãˆæ–¹ã¯ã€t-wada ã•ã‚“ãŒ [é–‹ç™ºç”Ÿç”£æ€§ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ 2025](https://dev-productivity-con.findy-code.io/2025#special-sessions) ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸ **Behavior Changeï¼ˆæŒ¯ã‚‹èˆã„ã®å¤‰æ›´ï¼‰** ã¨ **Structure Changeï¼ˆæ§‹é€ ã®å¤‰æ›´ï¼‰** ã®åŒºåˆ¥ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

<RichLinkCard href="https://www.oreilly.com/library/view/tidy-first/9781098151232/" title="Tidy First?: A Personal Exercise in Empirical Software Design" description="By Kent Beck. Messy code is a nuisance. Tidying code, to make it more readable, requires breaking it up into manageable sections." />

å…ƒãƒã‚¿ã¯ Kent Beck ã®è‘—æ›¸ "Tidy First?" ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’ã€ŒæŒ¯ã‚‹èˆã„ã®å¤‰æ›´ã€ã¨ã€Œæ§‹é€ ã®å¤‰æ›´ã€ã«åˆ†ã‘ã¦è€ƒãˆã‚‹ã“ã¨ã§ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è² è·ã‚’ä¸‹ã’ã€å¤‰æ›´ã®æ„å›³ã‚’æ˜ç¢ºã«ã™ã‚‹ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

#### åˆ¥æ¡ˆä»¶ã§ã®çµŒé¨“

ä»¥å‰ã€ä¼šç¤¾ã®åˆ¥ã®æ¡ˆä»¶ã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™ºã‚’ã—ãŸéš›ã«ã‚‚ã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘ã®ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã® 1 ã¤ã¨ã—ã¦ Playwright ã§ E2E ãƒ†ã‚¹ãƒˆã‚’æ§‹ç¯‰ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ `app` ã¨ `infra` ã‚’åˆ†é›¢ã—ã¦ãŠã‚Šã€`app/` é…ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ CI ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã«ã—ã¦ã„ã¾ã—ãŸã€‚
ã—ã‹ã—ã€E2E ãƒ†ã‚¹ãƒˆã‚’ CI ã«çµ„ã¿è¾¼ã‚“ã çµæœã€**å®Ÿè¡Œæ™‚é–“ãŒ 13 åˆ†**ã«ã¾ã§è†¨ã‚‰ã¿ã€CI ãŒã¨ã¦ã¤ã‚‚ãªã„ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

å•é¡Œã¯ã€UI ã«å½±éŸ¿ãŒãªã„ã¨ã‚ã‹ã‚Šãã£ã¦ã„ã‚‹å¤‰æ›´ï¼ˆä¾‹ãˆã°ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã§ã‚‚ã€æ¯å›ãƒ•ãƒ« E2E ãƒ†ã‚¹ãƒˆãŒèµ°ã£ã¦ã—ã¾ã£ã¦ã„ãŸã“ã¨ã§ã™ã€‚
**å¤‰æ›´ã®æ€§è³ªã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆç¯„å›²ã‚’çµã‚‹ã¹ãã ã£ãŸ**ã€ã¨ã„ã†å­¦ã³ã‚’å¾—ã¾ã—ãŸã€‚

#### ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ†å²

ã“ã®çµŒé¨“ã‚’è¸ã¾ãˆã€koborin.ai ã§ã¯ PR ãƒ©ãƒ™ãƒ«ã«ã‚ˆã£ã¦ CI ã®å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ†å²ã•ã›ã¦ã„ã¾ã™ã€‚

| ãƒ©ãƒ™ãƒ« | æ„å‘³ | CI ã®æŒ™å‹• |
| --- | --- | --- |
| `change:behavior` | æŒ¯ã‚‹èˆã„ã®å¤‰æ›´ï¼ˆUI/å‡ºåŠ›/è¨­å®šãŒå¤‰ã‚ã‚‹ï¼‰ | ãƒ•ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆlint + build + auditï¼‰ |
| `change:structure` | æ§‹é€ ã®å¤‰æ›´ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿/ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ | è»½é‡ãƒã‚§ãƒƒã‚¯ï¼ˆlint ã®ã¿ï¼‰ |

GitHub Actions ã§ã¯ã€PR ã®ãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã—ã¦ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ†å²ã—ã¦ã„ã¾ã™ï¼š

```yaml
- name: Determine change type (labels)
  id: change-type
  run: |
    if [[ "${{ contains(github.event.pull_request.labels.*.name, 'change:structure') }}" == "true" ]]; then
      echo "type=structure" >> "$GITHUB_OUTPUT"
    else
      echo "type=behavior" >> "$GITHUB_OUTPUT"
    fi

- name: Build
  if: steps.change-type.outputs.type == 'behavior'
  working-directory: app
  run: npm run build
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `behavior`ï¼ˆãƒ•ãƒ«ãƒã‚§ãƒƒã‚¯ï¼‰ã¨ã—ã¦ã€æ˜ç¤ºçš„ã« `change:structure` ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã®ã¿è»½é‡ãƒã‚§ãƒƒã‚¯ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

#### AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘ã®æ˜æ–‡åŒ–

ã“ã®å¤‰æ›´ã‚¿ã‚¤ãƒ—ã®åŒºåˆ¥ã¯ã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ PR ã‚’ä½œæˆã™ã‚‹éš›ã«ã‚‚æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚

`AGENTS.md` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå®šç¾©ã‚’è¨˜è¼‰ã—ã¦ãŠãã“ã¨ã§ã€AI ãŒå¤‰æ›´å†…å®¹ã‚’è¦‹ã¦é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼š

- **Behavior Change**ï¼š`app/src/content/docs/` é…ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¤‰æ›´ã€`astro.config.mjs` ã‚„ `Dockerfile` ã®å¤‰æ›´ã€Pulumi ã‚¹ã‚¿ãƒƒã‚¯ã®å¤‰æ›´ãªã©
- **Structure Change**ï¼š`README.md` ã‚„ `AGENTS.md` ã®æ›´æ–°ã€ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãªã©

ã¾ã é‹ç”¨ãŒå®šç€ã™ã‚‹ã¾ã§ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šãã†ã§ã™ãŒã€**ã€Œã©ã“ã¾ã§ CI ã‚’å›ã™ã‹ã€ã‚’å¤‰æ›´ã®æ€§è³ªã«å¿œã˜ã¦èª¿æ•´ã™ã‚‹**ã¨ã„ã†è€ƒãˆæ–¹ã¯ã€é–‹ç™ºä½“é¨“ã®æ”¹å–„ã«åŠ¹æœãŒã‚ã‚‹ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

### Workload Identity Federation

ã™ã¹ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ **Workload Identity Federation** ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ GitHub Secrets ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

GitHub Actions ã® OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ Google Cloud ã«èªè¨¼ã—ã€äº‹å‰ã«è¨­å®šã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å€Ÿç”¨ï¼ˆimpersonateï¼‰ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

<RichLinkCard href="https://cloud.google.com/iam/docs/workload-identity-federation" title="Workload Identity Federation | IAM Documentation | Google Cloud" description="Workload identity federation lets you grant on-premises or multi-cloud workloads access to Google Cloud resources." />

---

## å®Ÿè£…è©³ç´°

ã“ã“ã‹ã‚‰ã¯ã€å…·ä½“çš„ãªå®Ÿè£…å†…å®¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã„ã¦ã”è¦§ãã ã•ã„ã€‚

### Stack åˆ¥ã‚¤ãƒ³ãƒ•ãƒ©å®Ÿè£…

<RichLinkCard href="https://github.com/nozomi-koborinai/koborin-ai/tree/main/infra" title="koborin-ai/infra at main Â· nozomi-koborinai/koborin-ai" description="Pulumi Go stacks for koborin.ai infrastructure (shared, dev, prod)." />

#### infra/stacks/shared.go

å…±é€šãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼š

- **API ã®æœ‰åŠ¹åŒ–**ï¼šCloud Run, Compute, IAM, Artifact Registry, IAP ãªã©
- **Artifact Registry**ï¼šã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜å ´æ‰€
- **Global Static IP**ï¼šPREMIUM tier ã®é™çš„ IP
- **Managed SSL Certificate**ï¼š`koborin.ai` ã¨ `dev.koborin.ai` ã®ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³è¨¼æ˜æ›¸
- **URL Map**ï¼šãƒ›ã‚¹ãƒˆåãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- **Backend Services**ï¼šdevï¼ˆIAP æœ‰åŠ¹ï¼‰ã¨ prodï¼ˆIAP ãªã—ï¼‰
- **Serverless NEG**ï¼šCloud Run ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¥ç¶šï¼ˆã‚µãƒ¼ãƒ“ã‚¹åã‚’æ–‡å­—åˆ—ã§å‚ç…§ã™ã‚‹ã“ã¨ã§å¾ªç’°ä¾å­˜ã‚’å›é¿ï¼‰
- **Workload Identity Federation**ï¼šGitHub Actions ã‹ã‚‰ã®èªè¨¼ç”¨

<details>
<summary>`shared.go` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```go
package stacks

import (
	"strings"

	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/artifactregistry"
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/compute"
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/iam"
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/iap"
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/projects"
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/serviceaccount"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi/config"
)

// Shared creates resources for the shared stack.
func Shared(ctx *pulumi.Context) error {
	cfg := config.New(ctx, "")
	gcpCfg := config.New(ctx, "gcp")

	projectID := gcpCfg.Require("project")
	projectNumber := cfg.Require("projectNumber")
	iapUser := cfg.Require("iapUser")
	oauthClientID := cfg.Require("oauthClientId")
	oauthClientSecret := cfg.RequireSecret("oauthClientSecret")

	// ========================================
	// Enable Required APIs
	// ========================================

	requiredAPIs := []string{
		"run.googleapis.com",
		"compute.googleapis.com",
		"iam.googleapis.com",
		"cloudresourcemanager.googleapis.com",
		"artifactregistry.googleapis.com",
		"cloudbuild.googleapis.com",
		"iap.googleapis.com",
		"monitoring.googleapis.com",
		"logging.googleapis.com",
		"certificatemanager.googleapis.com",
	}

	var apiServices []pulumi.Resource
	for _, api := range requiredAPIs {
		logicalName := "api-" + strings.ReplaceAll(api, ".", "-")
		svc, err := projects.NewService(ctx, logicalName, &projects.ServiceArgs{
			Project:                  pulumi.String(projectID),
			Service:                  pulumi.String(api),
			DisableDependentServices: pulumi.Bool(false),
			DisableOnDestroy:         pulumi.Bool(false),
		})
		if err != nil {
			return err
		}
		apiServices = append(apiServices, svc)
	}

	// ========================================
	// Artifact Registry
	// ========================================

	_, err := artifactregistry.NewRepository(ctx, "artifact-registry", &artifactregistry.RepositoryArgs{
		Project:      pulumi.String(projectID),
		Location:     pulumi.String("asia-northeast1"),
		RepositoryId: pulumi.String("koborin-ai-web"),
		Description:  pulumi.String("Container images for koborin.ai web application (dev/prod)"),
		Format:       pulumi.String("DOCKER"),
		DockerConfig: &artifactregistry.RepositoryDockerConfigArgs{
			ImmutableTags: pulumi.Bool(true),
		},
	}, pulumi.DependsOn(apiServices))
	if err != nil {
		return err
	}

	// ========================================
	// Global Static IP
	// ========================================

	staticIP, err := compute.NewGlobalAddress(ctx, "global-ip", &compute.GlobalAddressArgs{
		Project:     pulumi.String(projectID),
		Name:        pulumi.String("koborin-ai-global-ip"),
		AddressType: pulumi.String("EXTERNAL"),
		IpVersion:   pulumi.String("IPV4"),
		Description: pulumi.String("Static IP for koborin.ai HTTPS load balancer"),
	}, pulumi.DependsOn(apiServices))
	if err != nil {
		return err
	}

	// ========================================
	// Dev Environment Backend
	// ========================================

	devNEG, err := compute.NewRegionNetworkEndpointGroup(ctx, "dev-neg", &compute.RegionNetworkEndpointGroupArgs{
		Project:             pulumi.String(projectID),
		Region:              pulumi.String("asia-northeast1"),
		Name:                pulumi.String("koborin-ai-dev-neg"),
		NetworkEndpointType: pulumi.String("SERVERLESS"),
		CloudRun: &compute.RegionNetworkEndpointGroupCloudRunArgs{
			Service: pulumi.String("koborin-ai-web-dev"),
		},
	}, pulumi.DependsOn(apiServices))
	if err != nil {
		return err
	}

	devBackend, err := compute.NewBackendService(ctx, "dev-backend", &compute.BackendServiceArgs{
		Project:              pulumi.String(projectID),
		Name:                 pulumi.String("koborin-ai-dev-backend"),
		Protocol:             pulumi.String("HTTP"),
		LoadBalancingScheme:  pulumi.String("EXTERNAL_MANAGED"),
		TimeoutSec:           pulumi.Int(30),
		CustomResponseHeaders: pulumi.StringArray{pulumi.String("X-Robots-Tag: noindex, nofollow")},
		Backends: compute.BackendServiceBackendArray{
			&compute.BackendServiceBackendArgs{
				Group:          devNEG.ID(),
				BalancingMode:  pulumi.String("UTILIZATION"),
				CapacityScaler: pulumi.Float64(1.0),
			},
		},
		Iap: &compute.BackendServiceIapArgs{
			Enabled:            pulumi.Bool(true),
			Oauth2ClientId:     pulumi.String(oauthClientID),
			Oauth2ClientSecret: oauthClientSecret,
		},
	}, pulumi.DependsOn([]pulumi.Resource{devNEG}))
	if err != nil {
		return err
	}

	_, err = iap.NewWebBackendServiceIamBinding(ctx, "dev-iap-access", &iap.WebBackendServiceIamBindingArgs{
		Project:           pulumi.String(projectID),
		WebBackendService: devBackend.Name,
		Role:              pulumi.String("roles/iap.httpsResourceAccessor"),
		Members:           pulumi.StringArray{pulumi.Sprintf("user:%s", iapUser)},
	}, pulumi.DependsOn([]pulumi.Resource{devBackend}))
	if err != nil {
		return err
	}

	// ========================================
	// Prod Environment Backend
	// ========================================

	prodNEG, err := compute.NewRegionNetworkEndpointGroup(ctx, "prod-neg", &compute.RegionNetworkEndpointGroupArgs{
		Project:             pulumi.String(projectID),
		Region:              pulumi.String("asia-northeast1"),
		Name:                pulumi.String("koborin-ai-prod-neg"),
		NetworkEndpointType: pulumi.String("SERVERLESS"),
		CloudRun: &compute.RegionNetworkEndpointGroupCloudRunArgs{
			Service: pulumi.String("koborin-ai-web-prod"),
		},
	}, pulumi.DependsOn(apiServices))
	if err != nil {
		return err
	}

	prodBackend, err := compute.NewBackendService(ctx, "prod-backend", &compute.BackendServiceArgs{
		Project:             pulumi.String(projectID),
		Name:                pulumi.String("koborin-ai-prod-backend"),
		Protocol:            pulumi.String("HTTP"),
		LoadBalancingScheme: pulumi.String("EXTERNAL_MANAGED"),
		TimeoutSec:          pulumi.Int(30),
		Backends: compute.BackendServiceBackendArray{
			&compute.BackendServiceBackendArgs{
				Group:          prodNEG.ID(),
				BalancingMode:  pulumi.String("UTILIZATION"),
				CapacityScaler: pulumi.Float64(1.0),
			},
		},
		LogConfig: &compute.BackendServiceLogConfigArgs{
			Enable:     pulumi.Bool(true),
			SampleRate: pulumi.Float64(1.0),
		},
	}, pulumi.DependsOn([]pulumi.Resource{prodNEG}))
	if err != nil {
		return err
	}

	// ========================================
	// HTTPS Load Balancer
	// ========================================

	sslCert, err := compute.NewManagedSslCertificate(ctx, "managed-cert", &compute.ManagedSslCertificateArgs{
		Project: pulumi.String(projectID),
		Name:    pulumi.String("koborin-ai-cert"),
		Managed: &compute.ManagedSslCertificateManagedArgs{
			Domains: pulumi.StringArray{
				pulumi.String("koborin.ai"),
				pulumi.String("dev.koborin.ai"),
			},
		},
	}, pulumi.DependsOn(apiServices))
	if err != nil {
		return err
	}

	urlMap, err := compute.NewURLMap(ctx, "url-map", &compute.URLMapArgs{
		Project:        pulumi.String(projectID),
		Name:           pulumi.String("koborin-ai-url-map"),
		Description:    pulumi.String("Routes traffic to dev/prod backends based on host header"),
		DefaultService: prodBackend.ID(),
		HostRules: compute.URLMapHostRuleArray{
			&compute.URLMapHostRuleArgs{
				Hosts:       pulumi.StringArray{pulumi.String("koborin.ai")},
				PathMatcher: pulumi.String("prod-matcher"),
			},
			&compute.URLMapHostRuleArgs{
				Hosts:       pulumi.StringArray{pulumi.String("dev.koborin.ai")},
				PathMatcher: pulumi.String("dev-matcher"),
			},
		},
		PathMatchers: compute.URLMapPathMatcherArray{
			&compute.URLMapPathMatcherArgs{
				Name:           pulumi.String("prod-matcher"),
				DefaultService: prodBackend.ID(),
			},
			&compute.URLMapPathMatcherArgs{
				Name:           pulumi.String("dev-matcher"),
				DefaultService: devBackend.ID(),
			},
		},
	}, pulumi.DependsOn([]pulumi.Resource{devBackend, prodBackend}))
	if err != nil {
		return err
	}

	httpsProxy, err := compute.NewTargetHttpsProxy(ctx, "https-proxy", &compute.TargetHttpsProxyArgs{
		Project: pulumi.String(projectID),
		Name:    pulumi.String("koborin-ai-https-proxy"),
		UrlMap:  urlMap.ID(),
		SslCertificates: pulumi.StringArray{
			sslCert.ID(),
		},
	}, pulumi.DependsOn([]pulumi.Resource{urlMap, sslCert}))
	if err != nil {
		return err
	}

	_, err = compute.NewGlobalForwardingRule(ctx, "forwarding-rule", &compute.GlobalForwardingRuleArgs{
		Project:             pulumi.String(projectID),
		Name:                pulumi.String("koborin-ai-forwarding-rule"),
		Target:              httpsProxy.ID(),
		PortRange:           pulumi.String("443"),
		IpProtocol:          pulumi.String("TCP"),
		LoadBalancingScheme: pulumi.String("EXTERNAL_MANAGED"),
		NetworkTier:         pulumi.String("PREMIUM"),
		IpAddress:           staticIP.Address,
	}, pulumi.DependsOn([]pulumi.Resource{httpsProxy, staticIP}))
	if err != nil {
		return err
	}

	// ========================================
	// Workload Identity (for GitHub Actions)
	// ========================================

	workloadIdentityPool, err := iam.NewWorkloadIdentityPool(ctx, "github-actions-pool", &iam.WorkloadIdentityPoolArgs{
		Project:                pulumi.String(projectID),
		WorkloadIdentityPoolId: pulumi.String("github-actions-pool"),
		DisplayName:            pulumi.String("github-actions-pool"),
		Description:            pulumi.String("Workload Identity Pool for GitHub Actions workflows"),
	})
	if err != nil {
		return err
	}

	_, err = iam.NewWorkloadIdentityPoolProvider(ctx, "github-provider", &iam.WorkloadIdentityPoolProviderArgs{
		Project:                        pulumi.String(projectID),
		WorkloadIdentityPoolId:         workloadIdentityPool.WorkloadIdentityPoolId,
		WorkloadIdentityPoolProviderId: pulumi.String("actions-firebase-provider"),
		DisplayName:                    pulumi.String("github-actions-provider"),
		Description:                    pulumi.String("GitHub Actions OIDC provider"),
		AttributeCondition: pulumi.String(`assertion.repository_owner == "nozomi-koborinai"`),
		AttributeMapping: pulumi.StringMap{
			"google.subject":             pulumi.String("assertion.repository"),
			"attribute.repository_owner": pulumi.String("assertion.repository_owner"),
		},
		Oidc: &iam.WorkloadIdentityPoolProviderOidcArgs{
			IssuerUri: pulumi.String("https://token.actions.githubusercontent.com"),
		},
	})
	if err != nil {
		return err
	}

	githubActionsSA, err := serviceaccount.NewAccount(ctx, "github-actions-sa", &serviceaccount.AccountArgs{
		Project:     pulumi.String(projectID),
		AccountId:   pulumi.String("github-actions-service"),
		DisplayName: pulumi.String("github-actions-service"),
		Description: pulumi.String("Service account for GitHub Actions to deploy via Pulumi"),
	})
	if err != nil {
		return err
	}

	_, err = serviceaccount.NewIAMMember(ctx, "github-wif-user", &serviceaccount.IAMMemberArgs{
		ServiceAccountId: githubActionsSA.Name,
		Role:             pulumi.String("roles/iam.workloadIdentityUser"),
		Member: pulumi.Sprintf(
			"principal://iam.googleapis.com/projects/%s/locations/global/workloadIdentityPools/%s/subject/nozomi-koborinai/koborin-ai",
			projectNumber,
			workloadIdentityPool.WorkloadIdentityPoolId,
		),
	})
	if err != nil {
		return err
	}

	deployerRoles := []string{
		"roles/artifactregistry.admin",
		"roles/cloudbuild.builds.builder",
		"roles/cloudbuild.builds.viewer",
		"roles/run.admin",
		"roles/compute.admin",
		"roles/iap.admin",
		"roles/logging.admin",
		"roles/logging.viewer",
		"roles/monitoring.admin",
		"roles/resourcemanager.projectIamAdmin",
		"roles/iam.serviceAccountUser",
		"roles/iam.serviceAccountAdmin",
		"roles/iam.workloadIdentityPoolAdmin",
		"roles/serviceusage.serviceUsageAdmin",
		"roles/storage.objectAdmin",
	}

	for _, role := range deployerRoles {
		logicalName := "deployer-sa-" + strings.ReplaceAll(strings.ReplaceAll(role, ".", "-"), "/", "-")
		_, err = projects.NewIAMMember(ctx, logicalName, &projects.IAMMemberArgs{
			Project: pulumi.String(projectID),
			Role:    pulumi.String(role),
			Member:  pulumi.Sprintf("serviceAccount:%s", githubActionsSA.Email),
		})
		if err != nil {
			return err
		}
	}

	return nil
}
```

</details>

#### infra/stacks/dev.go

é–‹ç™ºç’°å¢ƒã® Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼š

- **Cloud Run Service**ï¼š`koborin-ai-web-dev`
- **IAM**ï¼šIAP Service Agent ã« `roles/run.invoker` ã‚’ä»˜ä¸

<details>
<summary>`dev.go` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```go
package stacks

import (
	"fmt"

	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/cloudrunv2"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi/config"
)

func Dev(ctx *pulumi.Context) error {
	cfg := config.New(ctx, "")
	gcpCfg := config.New(ctx, "gcp")

	projectID := gcpCfg.Require("project")
	projectNumber := cfg.Require("projectNumber")
	imageURI := cfg.Require("imageUri")

	webDev, err := cloudrunv2.NewService(ctx, "web-dev", &cloudrunv2.ServiceArgs{
		Project:  pulumi.String(projectID),
		Location: pulumi.String("asia-northeast1"),
		Name:     pulumi.String("koborin-ai-web-dev"),
		Ingress:  pulumi.String("INGRESS_TRAFFIC_INTERNAL_LOAD_BALANCER"),
		Template: &cloudrunv2.ServiceTemplateArgs{
			ExecutionEnvironment: pulumi.String("EXECUTION_ENVIRONMENT_GEN2"),
			Containers: cloudrunv2.ServiceTemplateContainerArray{
				&cloudrunv2.ServiceTemplateContainerArgs{
					Image: pulumi.String(imageURI),
					Envs: cloudrunv2.ServiceTemplateContainerEnvArray{
						&cloudrunv2.ServiceTemplateContainerEnvArgs{
							Name:  pulumi.String("NODE_ENV"),
							Value: pulumi.String("development"),
						},
						&cloudrunv2.ServiceTemplateContainerEnvArgs{
							Name:  pulumi.String("NEXT_PUBLIC_ENV"),
							Value: pulumi.String("dev"),
						},
					},
				},
			},
			Scaling: &cloudrunv2.ServiceTemplateScalingArgs{
				MinInstanceCount: pulumi.Int(0),
				MaxInstanceCount: pulumi.Int(1),
			},
		},
		Traffics: cloudrunv2.ServiceTrafficArray{
			&cloudrunv2.ServiceTrafficArgs{
				Type:    pulumi.String("TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST"),
				Percent: pulumi.Int(100),
			},
		},
	})
	if err != nil {
		return err
	}

	_, err = cloudrunv2.NewServiceIamMember(ctx, "web-dev-iap-invoker", &cloudrunv2.ServiceIamMemberArgs{
		Project:  pulumi.String(projectID),
		Location: pulumi.String("asia-northeast1"),
		Name:     webDev.Name,
		Role:     pulumi.String("roles/run.invoker"),
		Member:   pulumi.String(fmt.Sprintf("serviceAccount:service-%s@gcp-sa-iap.iam.gserviceaccount.com", projectNumber)),
	})
	if err != nil {
		return err
	}

	return nil
}
```

</details>

#### infra/stacks/prod.go

æœ¬ç•ªç’°å¢ƒã® Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼š

- **Cloud Run Service**ï¼š`koborin-ai-web-prod`
- **IAM**ï¼š`allUsers` ã« `roles/run.invoker` ã‚’ä»˜ä¸ï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

<details>
<summary>`prod.go` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```go
package stacks

import (
	"github.com/pulumi/pulumi-gcp/sdk/v8/go/gcp/cloudrunv2"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi/config"
)

func Prod(ctx *pulumi.Context) error {
	cfg := config.New(ctx, "")
	gcpCfg := config.New(ctx, "gcp")

	projectID := gcpCfg.Require("project")
	imageURI := cfg.Require("imageUri")

	webProd, err := cloudrunv2.NewService(ctx, "web-prod", &cloudrunv2.ServiceArgs{
		Project:  pulumi.String(projectID),
		Location: pulumi.String("asia-northeast1"),
		Name:     pulumi.String("koborin-ai-web-prod"),
		Ingress:  pulumi.String("INGRESS_TRAFFIC_INTERNAL_LOAD_BALANCER"),
		Template: &cloudrunv2.ServiceTemplateArgs{
			ExecutionEnvironment: pulumi.String("EXECUTION_ENVIRONMENT_GEN2"),
			Containers: cloudrunv2.ServiceTemplateContainerArray{
				&cloudrunv2.ServiceTemplateContainerArgs{
					Image: pulumi.String(imageURI),
					Envs: cloudrunv2.ServiceTemplateContainerEnvArray{
						&cloudrunv2.ServiceTemplateContainerEnvArgs{
							Name:  pulumi.String("NODE_ENV"),
							Value: pulumi.String("production"),
						},
						&cloudrunv2.ServiceTemplateContainerEnvArgs{
							Name:  pulumi.String("NEXT_PUBLIC_ENV"),
							Value: pulumi.String("prod"),
						},
					},
				},
			},
			Scaling: &cloudrunv2.ServiceTemplateScalingArgs{
				MinInstanceCount: pulumi.Int(0),
				MaxInstanceCount: pulumi.Int(10),
			},
		},
		Traffics: cloudrunv2.ServiceTrafficArray{
			&cloudrunv2.ServiceTrafficArgs{
				Type:    pulumi.String("TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST"),
				Percent: pulumi.Int(100),
			},
		},
	})
	if err != nil {
		return err
	}

	_, err = cloudrunv2.NewServiceIamMember(ctx, "web-prod-invoker", &cloudrunv2.ServiceIamMemberArgs{
		Project:  pulumi.String(projectID),
		Location: pulumi.String("asia-northeast1"),
		Name:     webProd.Name,
		Role:     pulumi.String("roles/run.invoker"),
		Member:   pulumi.String("allUsers"),
	})
	if err != nil {
		return err
	}

	return nil
}
```

</details>

### App å®Ÿè£…

<RichLinkCard href="https://github.com/nozomi-koborinai/koborin-ai/tree/main/app" title="koborin-ai/app at main Â· nozomi-koborinai/koborin-ai" description="Astro + Starlight application for koborin.ai." />

#### app/astro.config.mjs

Astro ã¨ Starlight ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ï¼š

- **å¤šè¨€èªå¯¾å¿œ**ï¼š`root`ï¼ˆè‹±èªï¼‰ã¨ `ja`ï¼ˆæ—¥æœ¬èªï¼‰
- **ã‚µã‚¤ãƒ‰ãƒãƒ¼**ï¼š`app/src/sidebar.ts` ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- **ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ï¼šHead, ThemeSelect, Header, Sidebar, Pagination

<details>
<summary>`astro.config.mjs` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```javascript
import { defineConfig } from "astro/config";
import starlight from "@astrojs/starlight";
import rehypeMermaid from "rehype-mermaid";
import { sidebar } from "./src/sidebar.ts";

export default defineConfig({
  site: "https://koborin.ai",
  srcDir: "src",
  markdown: {
    rehypePlugins: [
      [
        rehypeMermaid,
        {
          strategy: "inline-svg",
          mermaidConfig: { theme: "neutral" },
        },
      ],
    ],
  },
  integrations: [
    starlight({
      title: "koborin.ai",
      defaultLocale: "root",
      locales: {
        root: { label: "English", lang: "en" },
        ja: { label: "æ—¥æœ¬èª" },
      },
      description: "Personal site + technical garden",
      favicon: "/favicon.png",
      logo: {
        src: "./src/assets/_shared/koborin-ai-header.webp",
        replacesTitle: true,
      },
      social: [
        { label: "GitHub", icon: "github", href: "https://github.com/nozomi-koborinai" },
        { label: "LinkedIn", icon: "linkedin", href: "https://linkedin.com/in/nozomi-koborinai" },
        { label: "X", icon: "x.com", href: "https://x.com/fender_kn" },
        { label: "Medium", icon: "document", href: "https://medium.com/@nozomi-koborinai" },
      ],
      sidebar,
      customCss: ['./src/styles/custom.css'],
      components: {
        Head: './src/components/Head.astro',
        ThemeSelect: './src/components/ThemeSelect.astro',
        Header: './src/components/SiteHeader.astro',
        Sidebar: './src/components/Sidebar.astro',
        Pagination: './src/components/Pagination.astro',
      },
      head: [
        { tag: 'meta', attrs: { name: 'twitter:card', content: 'summary_large_image' } },
      ],
      disable404Route: true,
    }),
  ],
});
```

</details>

#### app/Dockerfile

ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã€é™çš„ã‚µã‚¤ãƒˆã‚’ nginx ã§é…ä¿¡ã—ã¾ã™ï¼š

1. **Build stage**ï¼šNode.js ã§ OG ç”»åƒæœ€é©åŒ– â†’ `astro build`
2. **Runtime stage**ï¼š`nginx:alpine` ã§é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ä¿¡

<details>
<summary>`Dockerfile` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```dockerfile
# Build stage
FROM node:22-slim AS build
WORKDIR /app

RUN apt-get update && apt-get install -y \
    libnss3 libnspr4 libdbus-1-3 libatk1.0-0 libatk-bridge2.0-0 \
    libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 \
    libxfixes3 libxrandr2 libgbm1 libasound2 libpango-1.0-0 \
    libcairo2 webp imagemagick file \
    && rm -rf /var/lib/apt/lists/*

COPY package*.json ./
RUN npm install
RUN npx playwright install chromium
COPY . .

RUN ./scripts/optimize-og-images.sh
RUN npm run build

# Runtime stage
FROM nginx:alpine AS runtime
COPY ./nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 8080
```

</details>

#### app/nginx/nginx.conf

nginx ã®è¨­å®šã§ã™ï¼š

- **Port 8080**ï¼šCloud Run ã®è¦ä»¶ã«åˆã‚ã›ã¦
- **UTF-8 charset**ï¼š`llms.txt` ã®æ–‡å­—åŒ–ã‘å¯¾ç­–
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š**ï¼š`/_astro/` ã¯ 1 å¹´é–“ã€OG ç”»åƒã¯ 7 æ—¥é–“
- **WebP è‡ªå‹•é…ä¿¡**ï¼š`/og/*.png` ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ `.webp` ã«è§£æ±º

<details>
<summary>`nginx.conf` ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</summary>

```nginx
worker_processes  1;

events {
  worker_connections  1024;
}

http {
  server {
    listen 8080;
    server_name   _;

    root   /usr/share/nginx/html;
    index  index.html index.htm;
    include /etc/nginx/mime.types;

    charset utf-8;
    charset_types text/plain text/css application/json;

    gzip on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    error_page 404 /404.html;
    location = /404.html { root /usr/share/nginx/html; internal; }

    location /_astro/ { expires 1y; add_header Cache-Control "public, immutable"; }

    location ~ ^/og/(.+)\.(png|jpe?g)$ {
      set $webp_file /og/$1.webp;
      try_files $webp_file $uri =404;
      expires 7d;
      add_header Cache-Control "public";
    }

    location /og/ { expires 7d; add_header Cache-Control "public"; }
    location = /favicon.png { expires 30d; add_header Cache-Control "public"; }
    location / { try_files $uri $uri/index.html =404; }
  }
}
```

</details>

---

## ã¾ã¨ã‚

- **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ**ï¼šå€‹äººã‚µã‚¤ãƒˆãªã®ã§ GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ 1 ã¤ã«é›†ç´„
- **é–‹ç™ºè€…ä½“é¨“ã®ç¢ºä¿**ï¼šdev/prod ã‚’åˆ†é›¢ã—ã€IAP ã§é–‹ç™ºç’°å¢ƒã‚’ä¿è­·
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**ï¼šAPI/DB ä¸è¦ã€GitHub ã‚’ CMS ã¨ã—ã¦æ´»ç”¨ã€Starlight ã§æ§‹ç¯‰
- **CDKTF â†’ Pulumi Go ã¸ã®ç§»è¡Œ**ï¼šsunset ãƒªã‚¹ã‚¯ã‚’å›é¿ã—ã¤ã¤ã€å¥½ã¿ã®è¨€èªã§çµ±ä¸€
- **Behavior / Structure ã®æ„è­˜**ï¼šå¤‰æ›´ã®æ€§è³ªã«å¿œã˜ã¦ CI ã®å®Ÿè¡Œç¯„å›²ã‚’èª¿æ•´
- **ã‚µã‚¤ãƒˆæ©Ÿèƒ½**ï¼šllms.txt ã¨ Engagement Featuresï¼ˆGiscus, Webmention, Share buttonsï¼‰ã§èª­è€…ã¨ã¤ãªãŒã‚‹

## koborin.ai é–‹ç™ºãƒªãƒã‚¸ãƒˆãƒª

<RichLinkCard href="https://github.com/nozomi-koborinai/koborin-ai" title="koborin-ai" description="ğŸª´ A repository for building personal homepages and technical garden on GCP" />
